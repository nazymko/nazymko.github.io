# Tax Data Updater Script

This script automatically updates the tax data for your Global Tax Calculator Map using local LLM analysis of taxation information files.

## Overview

The `scripts/tax_data_updater.py` script:
1. Reads your current `taxData.js` file structure
2. Reads content from `scripts/data/taxation_*.txt` files for matching countries
3. Uses your local LLM (via Ollama Proxy) to analyze the content and extract structured tax details
4. Generates an updated `taxData2.js` file with corrected taxation data
5. Adds detailed comments showing what was added, modified, or removed

## Prerequisites

### Required Services
1. **Web Content Extractor API** running on `http://localhost:5000`
2. **Ollama Proxy API** running on `http://localhost:5001`
3. **Ollama with a suitable model** (e.g., llama2, gpt-oss, deepseek-r1)

### Required Files
- Taxation information files in format: `scripts/data/taxation_[country_name].txt`
- Examples: `scripts/data/taxation_germany.txt`, `scripts/data/taxation_united_states.txt`, etc.

## Installation

1. Install Python dependencies:
```bash
pip install requests
```

2. Ensure your local services are running:
   - Start Web Content Extractor: `python web_extractor.py`
   - Start Ollama Proxy: `python ollama_proxy.py`
   - Ensure Ollama is running with a suitable model

## Usage

### Basic Usage

```bash
python scripts/tax_data_updater.py
```

The script will:
- Automatically detect available models and use the first one found
- Process all countries that have corresponding taxation files
- Generate `js/taxData2.js` with updated data

### Expected File Structure

Place your taxation files in the scripts/data directory with this naming convention:

```
scripts/data/taxation_albania.txt
scripts/data/taxation_andorra.txt
scripts/data/taxation_argentina.txt
scripts/data/taxation_australia.txt
scripts/data/taxation_austria.txt
scripts/data/taxation_belgium.txt
scripts/data/taxation_bosnia_and_herzegovina.txt
scripts/data/taxation_brazil.txt
scripts/data/taxation_bulgaria.txt
scripts/data/taxation_canada.txt
scripts/data/taxation_china.txt
scripts/data/taxation_croatia.txt
scripts/data/taxation_cyprus.txt
scripts/data/taxation_czech_republic.txt
scripts/data/taxation_denmark.txt
scripts/data/taxation_estonia.txt
scripts/data/taxation_finland.txt
scripts/data/taxation_france.txt
scripts/data/taxation_germany.txt
scripts/data/taxation_greece.txt
scripts/data/taxation_hong_kong.txt
scripts/data/taxation_hungary.txt
scripts/data/taxation_iceland.txt
scripts/data/taxation_india.txt
scripts/data/taxation_indonesia.txt
scripts/data/taxation_ireland.txt
scripts/data/taxation_italy.txt
scripts/data/taxation_japan.txt
scripts/data/taxation_latvia.txt
scripts/data/taxation_liechtenstein.txt
scripts/data/taxation_lithuania.txt
scripts/data/taxation_luxembourg.txt
scripts/data/taxation_malta.txt
scripts/data/taxation_montenegro.txt
scripts/data/taxation_netherlands.txt
scripts/data/taxation_north_korea.txt
scripts/data/taxation_norway.txt
scripts/data/taxation_poland.txt
scripts/data/taxation_portugal.txt
scripts/data/taxation_russia.txt
scripts/data/taxation_serbia.txt
scripts/data/taxation_singapore.txt
scripts/data/taxation_slovakia.txt
scripts/data/taxation_south_africa.txt
scripts/data/taxation_spain.txt
scripts/data/taxation_sweden.txt
scripts/data/taxation_switzerland.txt
scripts/data/taxation_taiwan.txt
scripts/data/taxation_ukraine.txt
scripts/data/taxation_united_arab_emirates.txt
scripts/data/taxation_united_kingdom.txt
scripts/data/taxation_united_states.txt
```

## How It Works

### 1. Data Processing Pipeline

```
[taxData.js] → [Parse Original] → [Read taxation files] → [LLM Analysis] → [Generate taxData2.js]
```

### 2. LLM Analysis

The script sends each taxation file to your local LLM with a structured prompt requesting:
- Tax bracket information
- VAT/GST rates
- Special taxes (social security, etc.)
- Currency and system type
- Additional notes

### 3. Output Generation

The resulting `taxData2.js` file includes:
- **Header comments** with change summary
- **Per-country comments** indicating what changed
- **Structured data** in the same format as original
- **Helper functions** preserved from original file

## Sample Output

```javascript
// Tax data for major countries - UPDATED VERSION
// Generated by scripts/tax_data_updater.py on 2025-09-27 13:18:55
//
// CHANGES SUMMARY:
// - Added: 0 countries (none)
// - Modified: 2 countries (united_states, germany)
// - Removed: 0 countries (none)
// - Unchanged: 43 countries

export const taxData = {

  // [MODIFIED] Updated from taxation analysis
  // - Tax brackets updated: 7 -> 7 brackets
  // - VAT rate updated: N/A% -> None%
  "united_states": {
    name: "United States",
    currency: "USD",
    system: "progressive",
    countryCode: "US",
    coordinates: [39.8283, -98.5795],
    brackets: [
      {min: 0, max: 12950, rate: 10, description: "10% for income up to $12,950"},
      // ... more brackets
    ],
    vat: {
      hasVAT: false,
      description: "No federal VAT/GST; state sales taxes range 0%–10%+",
      notes: "Sales tax is collected at state and local levels.",
    },
    special_taxes: [
      {"type": "social_security", "target": "gross", "rate": 6.2, "description": "Social Security tax on wages up to $160,200 (2024)"},
      // ... more special taxes
    ],
    notes: "Standard deduction for single filers is $12,950 (2024). State income tax rates vary from 0% to 13.3%."
  },
  // ... more countries
```

## Error Handling

The script handles various scenarios:

- **Missing files**: Uses original data if taxation file doesn't exist
- **LLM failures**: Falls back to original data if analysis fails
- **Service unavailability**: Reports clear error messages
- **Invalid data**: Logs errors and continues processing

## Customization

### Model Selection

The script automatically selects the first available model. To use a specific model:

```python
processor = TaxDataProcessor(model_name="deepseek-r1:8b")
```

### Service URLs

To use different service URLs:

```python
processor = TaxDataProcessor(
    web_extractor_url="http://localhost:5000",
    ollama_proxy_url="http://localhost:5001"
)
```

## Output Interpretation

### Change Types

- **[ADDED]**: New country not in original data
- **[MODIFIED]**: Updated tax information from LLM analysis
- **[UNCHANGED]**: No changes from original data

### Data Fields

The script extracts and updates:
- **Tax brackets**: Progressive/flat tax rates with income thresholds
- **VAT information**: Standard rates, reduced rates, exemptions
- **Special taxes**: Social security, military taxes, etc.
- **System type**: progressive, flat, or zero_personal
- **Notes**: Important calculation details

## Verification

After running the script:

1. **Review the output**: Check `js/taxData2.js` for accuracy
2. **Compare changes**: Look at the comment annotations
3. **Test functionality**: Ensure the new data works with your application
4. **Backup original**: Keep `taxData.js` as backup before replacing

## Troubleshooting

### Common Issues

**Services not running**:
```
[ERROR] Web extractor service not available at http://localhost:5000
[ERROR] Ollama proxy service not available at http://localhost:5001
```
→ Start your local services first

**No models available**:
```
[ERROR] No models available in Ollama
```
→ Install a model: `ollama pull llama2`

**Encoding errors**:
```
UnicodeEncodeError: 'charmap' codec can't encode character
```
→ Use UTF-8 terminal or modify script output format

**Empty output**:
```
[ERROR] No JSON found in LLM response
```
→ Model may not understand the prompt; try a different model

### Debug Mode

For debugging, modify the script to print LLM responses:

```python
print(f"LLM Response: {content}")  # Add after line 265
```

## Performance Notes

- **Processing time**: ~2-3 seconds per country with LLM analysis
- **Rate limiting**: Built-in 1-second delay between requests
- **Memory usage**: Minimal, processes one country at a time
- **File size**: Output file similar size to input

## Security Considerations

- **Local processing**: All data stays on your machine
- **No API keys**: Uses local LLM, no external services
- **Data validation**: Script validates JSON output from LLM
- **Backup safety**: Original data preserved in separate file

## Contributing

To improve the script:

1. **Better parsing**: Enhance JavaScript-to-Python conversion
2. **More models**: Test with additional LLM models
3. **Validation**: Add more extensive data validation
4. **Performance**: Optimize for larger datasets

## License

This script is part of the Global Tax Calculator Map project and follows the same license terms.